---
import GuestProfilePictureOptimized from './GuestProfilePictureOptimized.astro';
import CountryFlag from './CountryFlag.astro';
import type { Language } from '../types';

export interface Props {
  guest: any;
  language?: Language;
  size?: 'small' | 'medium' | 'large';
  showEpisodeCount?: boolean;
}

const { guest, language, size = 'medium', showEpisodeCount = false } = Astro.props;

// Helper function to get guest URL for a specific language
function getGuestUrl(guest: any, lang?: Language): string {
  const slug = guest.data.slug || guest.slug;
  if (!lang) {
    // Use the first available language for the guest
    const firstLang = guest.data.languages[0];
    return firstLang === 'en' ? `/guests/${slug}/` : `/${firstLang}/guests/${slug}/`;
  }
  return lang === 'en' ? `/guests/${slug}/` : `/${lang}/guests/${slug}/`;
}

// Get LinkedIn URL from socialLinks
function getLinkedInUrl(guest: any): string | null {
  if (guest.data.linkedin) {
    return guest.data.linkedin;
  }
  if (guest.data.socialLinks) {
    const linkedinLink = guest.data.socialLinks.find((link: any) => link.platform === 'linkedin');
    return linkedinLink ? linkedinLink.url : null;
  }
  return null;
}

const linkedInUrl = getLinkedInUrl(guest);

// Get LinkedIn data with priority: LinkedIn data first, then fallback to static data
const guestName = guest.data.linkedin_full_name || guest.data.name;
const guestRole = guest.data.linkedin_current_role || guest.data.role;

// Check if guest is a freelancer
const isFreelancer = (
  (guest.data.linkedin_headline && guest.data.linkedin_headline.toLowerCase().includes('freelance')) ||
  (guest.data.linkedin_current_role && guest.data.linkedin_current_role.toLowerCase().includes('freelance'))
);

// Only use company if not freelancer and linkedin_current_company exists
const guestCompany = isFreelancer ? null : (guest.data.linkedin_current_company || null);

// Get LinkedIn headline
const linkedinHeadline = guest.data.linkedin_headline || null;

// Get LinkedIn country
const linkedinCountry = guest.data.linkedin_country || null;

// Truncate headline based on size
function truncateHeadline(headline: string | null, maxLength: number): string | null {
  if (!headline) return null;
  if (headline.length <= maxLength) return headline;
  
  // Smart truncation at word boundary
  const truncated = headline.substr(0, maxLength);
  const lastSpace = truncated.lastIndexOf(' ');
  return headline.substr(0, lastSpace > 0 ? lastSpace : maxLength) + '...';
}

// Get truncated headline based on screen size
const getHeadlineLength = () => {
  switch(size) {
    case 'small': return 80;
    case 'medium': return 120;
    case 'large': return 150;
    default: return 120;
  }
};

const truncatedHeadline = truncateHeadline(linkedinHeadline, getHeadlineLength());

// Size-specific classes
const sizeClasses = {
  small: {
    container: 'p-4',
    imageSize: 'md' as const,
    title: 'text-base font-semibold',
    subtitle: 'text-sm',
    headline: 'text-xs',
    linkedin: 'w-5 h-5',
    flagSize: 'sm' as const,
    gap: 'gap-3'
  },
  medium: {
    container: 'p-5',
    imageSize: 'lg' as const,
    title: 'text-lg font-semibold',
    subtitle: 'text-sm',
    headline: 'text-sm',
    linkedin: 'w-5 h-5',
    flagSize: 'sm' as const,
    gap: 'gap-4'
  },
  large: {
    container: 'p-6',
    imageSize: 'xl' as const,
    title: 'text-xl font-semibold',
    subtitle: 'text-base',
    headline: 'text-base',
    linkedin: 'w-6 h-6',
    flagSize: 'md' as const,
    gap: 'gap-4'
  }
};

const classes = sizeClasses[size];
---

<a 
  href={getGuestUrl(guest, language)} 
  class={`card card-interactive ${classes.container} block group relative`}
  aria-label={`View ${guestName}'s profile`}
>

  <div class={`flex flex-col items-center text-center ${classes.gap}`}>
    <!-- Guest Image - Centered -->
    <div class="group-hover:scale-105 transition-transform duration-300">
      <GuestProfilePictureOptimized 
        guest={guest}
        size={classes.imageSize}
        loading="lazy"
        grayscale={true}
      />
    </div>
    
    <!-- Guest Info -->
    <div class="w-full">
      <!-- Guest Name -->
      <h3 class={`${classes.title} text-gray-900 dark:text-white mb-1 group-hover:text-primary-600 dark:group-hover:text-primary-300 transition-colors`}>
        {guestName}
      </h3>
      
      <!-- Job Title and Company -->
      {(guestRole || guestCompany) && (
        <p class={`${classes.subtitle} text-gray-600 dark:text-gray-400 mb-3`}>
          {guestRole && guestCompany ? (
            <>{guestRole} at {guestCompany}</>
          ) : (
            guestRole || guestCompany
          )}
        </p>
      )}
      
      <!-- LinkedIn Headline -->
      {truncatedHeadline && (
        <div class="mb-3">
          <p class={`${classes.headline} italic text-gray-700 dark:text-gray-300 bg-gray-50 dark:bg-gray-800/30 rounded-md px-3 py-2`}
             title={linkedinHeadline}>
            "{truncatedHeadline}"
          </p>
        </div>
      )}
      
      <!-- Location with Country Flag -->
      {linkedinCountry && (
        <div class="flex justify-center mb-2">
          <CountryFlag 
            country={linkedinCountry}
            size={classes.flagSize}
            showName={true}
          />
        </div>
      )}
      
      <!-- Episode Count (optional) -->
      {showEpisodeCount && guest.data.episodeCount && (
        <p class={`${classes.subtitle} text-gray-500 dark:text-gray-400 mt-2`}>
          {guest.data.episodeCount} episode{guest.data.episodeCount !== 1 ? 's' : ''}
        </p>
      )}
    </div>
  </div>
</a>

<style>
  /* Enhanced hover effects */
  .card-interactive {
    @apply transition-all duration-300;
  }
  
  .card-interactive:hover {
    @apply shadow-lg scale-[1.02];
  }
  
  /* Ensure cards have consistent height in grid */
  .card-interactive {
    height: 100%;
  }
  
  /* Focus styles for accessibility */
  .card-interactive:focus-visible {
    @apply ring-2 ring-primary-500 ring-offset-2;
  }
</style>