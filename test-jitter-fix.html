<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jitter Fix Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 4px; 
            font-weight: bold;
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        .info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        #playingStatus {
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #007bff;
            border-radius: 4px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>ðŸŽµ Jitter Fix Verification Test</h1>
    
    <div class="status info">
        <strong>Purpose:</strong> Verify that the rapid play/pause toggling (jittering) issue has been fixed
    </div>

    <div id="playingStatus">Status: Not loaded</div>

    <div>
        <h2>Test Steps</h2>
        <button onclick="testHomepage()">1. Test Homepage PlayButton</button>
        <button onclick="testEpisodePage()">2. Test Episode Page PlayButton</button>
        <button onclick="monitorStateChanges()">3. Monitor State Changes</button>
        <button onclick="clearLog()">Clear Log</button>
    </div>

    <div id="results"></div>
    <div id="log"></div>

    <script>
        let stateChangeCount = 0;
        let monitoring = false;
        let monitorInterval = null;

        const log = (message, type = 'info') => {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            logDiv.textContent += `[${time}] ${type.toUpperCase()}: ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type}] ${message}`);
        };

        const updateStatus = (message, type = 'info') => {
            const statusDiv = document.getElementById('playingStatus');
            statusDiv.textContent = `Status: ${message}`;
            statusDiv.className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
        };

        const showResult = (title, success, message) => {
            const resultsDiv = document.getElementById('results');
            const resultClass = success ? 'success' : 'error';
            resultsDiv.innerHTML += `
                <div class="status ${resultClass}">
                    <strong>${title}:</strong> ${message}
                </div>
            `;
        };

        const clearLog = () => {
            document.getElementById('log').textContent = '';
            document.getElementById('results').innerHTML = '';
            stateChangeCount = 0;
        };

        const testHomepage = () => {
            log('Testing homepage for jitter issue...', 'info');
            const testUrl = 'http://localhost:4323/en/';
            
            // Open homepage in new tab for manual testing
            const newWindow = window.open(testUrl, '_blank');
            if (newWindow) {
                showResult('Homepage Test', true, 'Homepage opened in new tab. Click a play button and watch for jittering.');
                log('Homepage opened for manual testing', 'info');
                log('Instructions: Click any play button and observe if the play/pause button jitters rapidly', 'info');
            } else {
                showResult('Homepage Test', false, 'Failed to open homepage. Please check if dev server is running.');
            }
        };

        const testEpisodePage = () => {
            log('Testing episode page for jitter issue...', 'info');
            const testUrl = 'http://localhost:4323/en/episodes/unleash-your-primal-brain-with-tim-ash/';
            
            // Open episode page in new tab for manual testing
            const newWindow = window.open(testUrl, '_blank');
            if (newWindow) {
                showResult('Episode Test', true, 'Episode page opened in new tab. Click the play button and watch for jittering.');
                log('Episode page opened for manual testing', 'info');
                log('Instructions: Click the "Listen to this episode" button and observe behavior', 'info');
            } else {
                showResult('Episode Test', false, 'Failed to open episode page. Please check if dev server is running.');
            }
        };

        const monitorStateChanges = () => {
            if (monitoring) {
                log('Stopping state change monitoring...', 'info');
                monitoring = false;
                if (monitorInterval) {
                    clearInterval(monitorInterval);
                    monitorInterval = null;
                }
                updateStatus('Monitoring stopped');
                return;
            }

            log('Starting state change monitoring...', 'info');
            log('This will track rapid state changes that could cause jittering', 'info');
            monitoring = true;
            stateChangeCount = 0;
            
            const startTime = Date.now();
            let lastPlayingState = null;
            let rapidChangeCount = 0;
            
            updateStatus('Monitoring for rapid state changes...');
            
            monitorInterval = setInterval(() => {
                // Check for global audio player state if available
                if (typeof window !== 'undefined' && window.opener) {
                    try {
                        const parentWindow = window.opener;
                        if (parentWindow.audioPlayerStore) {
                            const state = parentWindow.audioPlayerStore.get();
                            const currentPlaying = state.isPlaying;
                            
                            if (lastPlayingState !== null && lastPlayingState !== currentPlaying) {
                                stateChangeCount++;
                                rapidChangeCount++;
                                
                                log(`State change #${stateChangeCount}: isPlaying changed from ${lastPlayingState} to ${currentPlaying}`, 'event');
                                
                                // Check for rapid changes (more than 3 changes in 1 second)
                                if (rapidChangeCount > 3) {
                                    log(`WARNING: Rapid state changes detected! ${rapidChangeCount} changes in quick succession`, 'error');
                                    updateStatus(`JITTER DETECTED: ${rapidChangeCount} rapid changes`, 'error');
                                }
                                
                                // Reset rapid change counter after 1 second
                                setTimeout(() => {
                                    rapidChangeCount = Math.max(0, rapidChangeCount - 1);
                                }, 1000);
                            }
                            
                            lastPlayingState = currentPlaying;
                            
                            // Update status
                            if (rapidChangeCount === 0) {
                                updateStatus(`Monitoring... (${stateChangeCount} total changes)`);
                            }
                        }
                    } catch (error) {
                        // Can't access parent window, continue monitoring
                    }
                }
                
                // Auto-stop after 30 seconds
                if (Date.now() - startTime > 30000) {
                    log('Stopping monitoring after 30 seconds', 'info');
                    monitoring = false;
                    clearInterval(monitorInterval);
                    monitorInterval = null;
                    
                    if (stateChangeCount === 0) {
                        showResult('Jitter Monitor', true, 'No state changes detected during monitoring period.');
                    } else if (stateChangeCount < 5) {
                        showResult('Jitter Monitor', true, `Normal state changes detected: ${stateChangeCount} changes in 30 seconds.`);
                    } else {
                        showResult('Jitter Monitor', false, `Possible jitter: ${stateChangeCount} state changes in 30 seconds.`);
                    }
                    
                    updateStatus('Monitoring complete');
                }
            }, 100); // Check every 100ms
        };

        // Auto-run initial test
        window.addEventListener('load', () => {
            log('Jitter fix verification test ready', 'info');
            log('The fixes implemented:', 'info');
            log('1. Added debouncing to audio play/pause events (100ms)', 'info');
            log('2. Prevented duplicate play calls when audio is already playing', 'info');
            log('3. Added state change detection to prevent unnecessary store updates', 'info');
            updateStatus('Ready for testing');
        });
    </script>
</body>
</html>