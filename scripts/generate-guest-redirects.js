#!/usr/bin/env node

import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Get all guest slugs from the content directory
function getGuestSlugs() {
  const guestsDir = path.join(__dirname, '../src/content/guests');
  const files = fs.readdirSync(guestsDir);
  const slugs = [];
  
  files.forEach(file => {
    if (file.endsWith('.mdx')) {
      const content = fs.readFileSync(path.join(guestsDir, file), 'utf8');
      const slugMatch = content.match(/slug:\s*"([^"]+)"/);
      if (slugMatch) {
        slugs.push(slugMatch[1]);
      }
    }
  });
  
  return slugs.sort();
}

// Generate redirects
function generateRedirects() {
  const guestSlugs = getGuestSlugs();
  const redirects = [];
  
  redirects.push('# ============================================================================');
  redirects.push('# GUEST PROFILE REDIRECTS');
  redirects.push('# ============================================================================');
  redirects.push('# Redirect old guest URLs to new guest profile pages');
  redirects.push('# Generated by scripts/generate-guest-redirects.js');
  redirects.push('');
  
  // For each language subdomain
  const languages = ['de', 'nl', 'es', 'en'];
  
  languages.forEach(lang => {
    redirects.push(`# ${lang.toUpperCase()} guest profile redirects`);
    
    guestSlugs.forEach(slug => {
      // Subdomain redirects
      if (lang === 'en') {
        // English was on main domain
        redirects.push(`https://cro.cafe/guest/${slug}  https://cro.cafe/guests/${slug}/  301!`);
        redirects.push(`https://www.cro.cafe/guest/${slug}  https://cro.cafe/guests/${slug}/  301!`);
      } else {
        // Other languages on subdomains
        redirects.push(`https://${lang}.cro.cafe/guest/${slug}  https://cro.cafe/guests/${slug}/  301!`);
        // Also handle gaste (German) and invitados (Spanish)
        if (lang === 'de') {
          redirects.push(`https://de.cro.cafe/gaste/${slug}  https://cro.cafe/guests/${slug}/  301!`);
        } else if (lang === 'es') {
          redirects.push(`https://es.cro.cafe/invitados/${slug}  https://cro.cafe/guests/${slug}/  301!`);
        }
      }
    });
    
    redirects.push('');
  });
  
  // Also add redirects for the main domain patterns
  redirects.push('# Main domain guest redirects (in case subdomains are manually changed)');
  guestSlugs.forEach(slug => {
    redirects.push(`/guest/${slug}  /guests/${slug}/  301!`);
    redirects.push(`/gaste/${slug}  /guests/${slug}/  301!`);
    redirects.push(`/invitados/${slug}  /guests/${slug}/  301!`);
  });
  
  return redirects.join('\n');
}

// Main
const output = generateRedirects();
console.log(output);
console.log('\n// Total guest profiles found:', getGuestSlugs().length);
console.log('// Copy the above output to public/_redirects in the GUEST PROFILE REDIRECTS section');